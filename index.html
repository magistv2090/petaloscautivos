<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pétalos Cautivos — Verarte | Libérate y Florece</title>
  <meta name="description" content="Sorteo Pétalos Cautivos: libera el candado, sigue nuestras redes y participa por una comida y el arreglo Pétalos Cautivos.">
  <style>
    :root{
      --rojo:#b30d1b; --vino:#7a0c17; --crema:#fff7f4; --oro:#c7a86b; --borde:#e6d8cb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:transparent;color:#2a2422;}
    /* Fondo con imagen a 20% */
    body::before{content:"";position:fixed;inset:0;background:url('fondo.png') center/cover no-repeat;opacity:.2;z-index:-2}
    body::after{content:"";position:fixed;inset:0;background:var(--crema);opacity:.6;z-index:-3}

    .wrap{min-height:100svh;display:grid;grid-template-rows:auto 1fr auto}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:40px;height:40px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.15)}
    .brand h1{margin:0;font-size:18px;color:var(--vino);letter-spacing:.5px}

    .hero{display:grid;place-items:center;padding:10px}
    .hero img.logo-centro{width:min(440px,80vw);height:auto;display:block;filter:drop-shadow(0 8px 24px rgba(0,0,0,.15))}

    main{display:grid;place-items:center;padding:16px}

    .grid{display:grid;grid-template-columns:1fr;gap:16px;max-width:1000px;width:100%}

    /* Caja y candado */
    .panel{background:#fff;border:1px solid var(--borde);border-radius:16px;box-shadow:0 20px 44px rgba(0,0,0,.12)}
    .panel .inner{padding:18px}
    .lock-area{display:grid;gap:10px;text-align:center}
    .lock-btn{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border:2px solid var(--vino);border-radius:999px;background:#fff;color:var(--vino);font-weight:700;cursor:pointer}
    .lock-btn:hover{background:#fff3f3}
    .padlock{width:46px;height:46px}
    .padlock .shackle{transform-origin:32px 18px;transition:transform .35s ease, translate .35s ease}
    .padlock.open .shackle{transform:translateY(-6px) rotate(-28deg)}

    .prizes{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .prize{background:#fff;border:1px solid var(--borde);border-radius:12px;overflow:hidden;text-align:center}
    .prize img{width:100%;height:200px;object-fit:cover}
    .prize b{display:block;padding:10px;color:#4b3b35}

    /* Formulario */
    form{display:grid;gap:10px}
    label{font-size:13px;color:#5a4b44}
    input, textarea{width:100%;padding:12px;border:1px solid var(--borde);border-radius:10px;background:#fff;font-size:14px}
    textarea{min-height:110px;resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .terms{display:flex;align-items:center;gap:10px}
    .btn{padding:13px 16px;border:none;border-radius:12px;background:var(--rojo);color:#fff;font-weight:800;font-size:15px;cursor:pointer}
    .btn:hover{background:#9a0a16;transform:translateY(-1px)}
    .btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
    .note{font-size:12px;color:#6a5a52}
    .follow{display:grid;gap:8px;margin:6px 0}
    .follow a{display:flex;justify-content:center;align-items:center;gap:8px;text-decoration:none;border:1px solid var(--borde);padding:10px;border-radius:10px;background:#fff;color:#2a2422}
    .follow a:hover{box-shadow:0 8px 20px rgba(0,0,0,.08)}

    /* Slider galería */
    .gallery{background:#fff;border:1px solid var(--borde);border-radius:16px;overflow:hidden}
    .gallery h3{margin:12px 16px 0;color:var(--vino)}
    .carousel{position:relative;overflow:hidden}
    .track{display:flex;transition:transform .5s ease}
    .track img{width:100%;max-height:840px;object-fit:cover;flex:0 0 100%}
    .controls{display:flex;justify-content:space-between;gap:10px;padding:10px 16px}
    .controls button{border:1px solid var(--borde);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}

    .cta-pide{display:grid;grid-template-columns:1fr;gap:12px;align-items:center}
    .cta-pide img{width:70%;max-width:400px;border-radius:12px;border:1px solid var(--borde);margin:0 auto}

    /* Modal emergente */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:center;z-index:50}
    .modal.show{display:grid}
    .modal .box{background:#fff;border-radius:16px;max-width:520px;padding:20px;border:1px solid var(--borde);text-align:center;transform:scale(0.8);transition:transform 0.3s ease}
    .modal.show .box{transform:scale(1)}
    .modal .box h4{margin:0 0 6px;color:var(--vino)}
    .modal .box button{margin-top:10px}

    /* Pétalos/confetti */
    #confetti{position:fixed;inset:0;pointer-events:none;z-index:40}

    /* Loading spinner */
    .loading{display:inline-block;width:20px;height:20px;border:3px solid #fff;border-radius:50%;border-top-color:transparent;animation:spin 1s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    footer{padding:16px;text-align:center;color:#6a5a52;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img src="logo2.png" alt="Logo del canal" loading="eager" />
      <h1>Pétalos Cautivos</h1>
    </div>
    <nav>
      <a href="https://www.tiktok.com/@billonarte" target="_blank" rel="noopener">TikTok @billonarte</a>
    </nav>
  </header>

  <section class="hero">
    <!-- Logo central -->
    <img src="logo.png" alt="Logo principal" class="logo-centro" />
    <!-- Audio de fondo: se desmutea al abrir el candado por políticas de autoplay -->
    <audio id="bgm" src="musica.mp3" preload="auto" loop autoplay muted></audio>
  </section>

  <main>
    <div class="grid">
      <!-- Panel 1: Candado y premios -->
      <div class="panel">
        <div class="inner">
          <div class="lock-area">
            <button class="lock-btn" id="openLock" aria-controls="form" aria-expanded="false">
              <svg class="padlock" id="lockIcon" viewBox="0 0 64 64" aria-hidden="true">
                <path class="shackle" d="M20 26V20a12 12 0 1 1 24 0v6" fill="none" stroke="#7a0c17" stroke-width="4"/>
                <rect x="14" y="26" width="36" height="28" rx="6" ry="6" fill="#ffffff" stroke="#cdb6a8" stroke-width="3"/>
                <circle cx="32" cy="40" r="4" fill="#c7a86b"/>
              </svg>
              <span>Abrir candado para participar</span>
            </button>
            <div class="prizes">
              <div class="prize"><img src="sorteo1.png" alt="Premio: comida"> <b>Premio: Comida en Verarte</b></div>
              <div class="prize"><img src="sorteo2.png" alt="Premio: Arreglo Pétalos Cautivos"> <b>Arreglo Pétalos Cautivos</b></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel 2: Formulario -->
      <div class="panel" id="formPanel" style="display:none">
        <div class="inner">
          <form id="form" novalidate>
            <div class="row2">
              <label>Nombre completo
                <input name="name" required placeholder="Ej: Ana Flores" />
              </label>
              <label>WhatsApp / Teléfono
                <input name="phone" required inputmode="tel" placeholder="Ej: +593 9xxxxxxx" />
              </label>
            </div>
            <div class="row2">
              <label>Correo electrónico
                <input name="email" type="email" required placeholder="tucorreo@dominio.com" />
              </label>
              <label>Usuario TikTok
                <input name="tiktok" placeholder="@tuusuario" />
              </label>
            </div>
            <div class="row2">
              <label>Usuario Facebook
                <input name="facebook" placeholder="/tu.perfil" />
              </label>
              <label>Token QR (automático)
                <input name="token" id="token" readonly />
              </label>
            </div>
            <label>¿Cómo te gustaría que sea el final de <em>Pétalos Cautivos</em>?
              <textarea name="ending" required placeholder="Escribe tu final soñado…"></textarea>
            </label>

            <div class="follow">
              <div class="note"><strong>Para participar en el sorteo debes seguir estas páginas y comentar en el video de la temporada 2 con el hashtag <code>#Verarte</code>:</strong></div>
              <a href="https://www.facebook.com/billonarte" target="_blank" rel="noopener">Seguir en Facebook</a>
              <a href="https://www.instagram.com/billonarte/" target="_blank" rel="noopener">Seguir en Instagram</a>
			  <a href="https://www.tiktok.com/@billonarte" target="_blank" rel="noopener">Seguir en Tiktok</a>
            </div>

            <button class="btn" id="submitBtn" type="submit">
              <span class="btn-text">Participar en el sorteo</span>
              <div class="loading" style="display:none"></div>
            </button>
          </form>
        </div>
      </div>

      <!-- Galería -->
      <div class="gallery panel">
        <div class="inner">
          <h3>NUESTROS TRABAJOS EN VERARTE</h3>
        </div>
        <div class="carousel">
          <div class="track" id="track">
            <img src="foto1.jpg" alt="Trabajo 1 en Verarte">
            <img src="foto2.jpg" alt="Trabajo 2 en Verarte">
            <img src="foto3.jpg" alt="Trabajo 3 en Verarte">
            <img src="foto4.jpg" alt="Trabajo 4 en Verarte">
            <img src="foto5.jpg" alt="Trabajo 5 en Verarte">
          </div>
          <div class="controls">
            <button id="prev">⟵ Anterior</button>
            <button id="next">Siguiente ⟶</button>
          </div>
        </div>
      </div>

      <!-- CTA Pídelo -->
      <div class="panel">
        <div class="inner cta-pide">
          <h3>PIDE NUESTRO ARREGLO PÉTALOS CAUTIVOS</h3>
          <img src="petalos1.jpg" alt="Arreglo Pétalos Cautivos" />
          <a class="btn" href="https://www.instagram.com/verarteloja/" target="_blank" rel="noopener">Pedir por Instagram</a>
        </div>
      </div>
    </div>
  </main>

  <footer>
    © 2025 Pétalos Cautivos — Verarte Campaña "Libérate y Florece".
  </footer>
</div>

<!-- Modal mensaje Libérate -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
  <div class="box">
    <h4 id="mTitle">✨ ¡Libérate!</h4>
    <p>Se abrió el cajón. Completa el formulario para entrar al sorteo.</p>
    <button class="btn" id="closeModal" type="button">Aceptar</button>
  </div>
</div>

<!-- Modal confirmación registro -->
<div id="successModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="sTitle">
  <div class="box">
    <h4 id="sTitle">🎉 ¡Gracias por registrarte!</h4>
    <p>Estás participando en el sorteo. ¡Que tengas mucha suerte!</p>
    <button class="btn" id="closeSuccessModal" type="button">Aceptar</button>
  </div>
</div>

<canvas id="confetti"></canvas>

<script>
  // Token desde URL
  const params = new URLSearchParams(location.search);
  const token = params.get('t') || 'demo-token';
  document.getElementById('token').value = token;

  // Candado
  const openBtn = document.getElementById('openLock');
  const lockIcon = document.getElementById('lockIcon');
  const formPanel = document.getElementById('formPanel');
  const modal = document.getElementById('modal');
  const closeModal = document.getElementById('closeModal');
  const successModal = document.getElementById('successModal');
  const closeSuccessModal = document.getElementById('closeSuccessModal');
  const bgm = document.getElementById('bgm');

  openBtn.addEventListener('click', ()=>{
    lockIcon.classList.add('open');
    openBtn.setAttribute('aria-expanded','true');
    setTimeout(()=>{ modal.classList.add('show'); }, 250);
    formPanel.style.display='block';
    constantPetalsActive = false; // Detener pétalos constantes
    intensePetals(); // efecto pétalos intenso
    // Intento desmutear audio tras interacción
    bgm.muted = false; bgm.play().catch(()=>{});
  });
  closeModal.addEventListener('click', ()=> modal.classList.remove('show'));
  closeSuccessModal.addEventListener('click', ()=> successModal.classList.remove('show'));

  // Carousel simple
  const track = document.getElementById('track');
  const slides = track.children; let index=0;
  function go(i){ index=(i+slides.length)%slides.length; track.style.transform=`translateX(-${index*100}%)`; }
  document.getElementById('next').onclick=()=>go(index+1);
  document.getElementById('prev').onclick=()=>go(index-1);
  setInterval(()=>go(index+1), 5000);

  // Sistema de pétalos mejorado
  const cf = document.getElementById('confetti'); 
  const ctx = cf.getContext('2d');
  function rs(){ cf.width=innerWidth; cf.height=innerHeight;} 
  rs(); 
  addEventListener('resize',rs);
  
  let bits = []; 
  let petalColors = [
    'rgba(179,13,27,0.8)',
    'rgba(122,12,23,0.9)', 
    'rgba(199,168,107,0.7)',
    'rgba(255,192,203,0.6)'
  ];
  let constantPetalsActive = true; // Control para pétalos constantes
  
  // Función para crear pétalos constantemente
  function createConstantPetals() {
    // Crear 2-3 pétalos cada frame para animación constante
    for(let i = 0; i < Math.random() * 3 + 1; i++) {
      bits.push({
        x: Math.random() * cf.width,
        y: -20,
        dx: (Math.random() - 0.5) * 1.5,
        dy: 0.5 + Math.random() * 1.5,
        life: 400 + Math.random() * 200,
        rot: Math.random() * 6.28,
        rotSpeed: (Math.random() - 0.5) * 0.1,
        size: 4 + Math.random() * 8,
        color: petalColors[Math.floor(Math.random() * petalColors.length)],
        sway: Math.random() * 0.02 + 0.01
      });
    }
  }
  
  // Función para efecto intenso (al abrir candado o enviar formulario)
  function intensePetals() {
    for(let i = 0; i < 150; i++) {
      bits.push({
        x: Math.random() * cf.width,
        y: -10 - Math.random() * 50,
        dx: (Math.random() - 0.5) * 4,
        dy: 1 + Math.random() * 3,
        life: 300 + Math.random() * 100,
        rot: Math.random() * 6.28,
        rotSpeed: (Math.random() - 0.5) * 0.15,
        size: 6 + Math.random() * 10,
        color: petalColors[Math.floor(Math.random() * petalColors.length)],
        sway: Math.random() * 0.03 + 0.02
      });
    }
  }
  
  // Loop de animación mejorado
  function animationLoop() {
    ctx.clearRect(0, 0, cf.width, cf.height);
    
    // Crear pétalos constantemente solo si está activo
    if (constantPetalsActive && Math.random() < 0.7) {
      createConstantPetals();
    }
    
    // Animar pétalos existentes
    bits.forEach(b => {
      // Movimiento con efecto de balanceo
      b.x += b.dx + Math.sin(Date.now() * b.sway) * 0.5;
      b.y += b.dy;
      b.dy += 0.01; // Aceleración suave
      b.rot += b.rotSpeed;
      b.life--;
      
      // Dibujar pétalo
      ctx.save();
      ctx.translate(b.x, b.y);
      ctx.rotate(b.rot);
      ctx.fillStyle = b.color;
      
      // Forma de pétalo más realista
      ctx.beginPath();
      ctx.ellipse(0, 0, b.size * 0.6, b.size, 0, 0, Math.PI * 2);
      ctx.fill();
      
      // Sombra sutil
      ctx.fillStyle = 'rgba(0,0,0,0.1)';
      ctx.beginPath();
      ctx.ellipse(1, 1, b.size * 0.6, b.size, 0, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.restore();
    });
    
    // Limpiar pétalos que ya no son visibles
    bits = bits.filter(b => b.life > 0 && b.y < cf.height + 50 && b.x > -50 && b.x < cf.width + 50);
    
    requestAnimationFrame(animationLoop);
  }
  
  // Iniciar animación
  animationLoop();

  // Envío a Telegram mejorado
  const TG_TOKEN = '1312015202:AAEEVNWbXjr3hkgcxUiWcp5pQkBd3g5K6iQ';
  const TG_CHAT = '-4633873588';
  
  async function notifyTelegram(payload) {
    const text = `🌺 <b>Nuevo participante en Pétalos Cautivos</b>\n\n` +
      `👤 <b>Nombre:</b> ${payload.name}\n` +
      `📱 <b>Teléfono:</b> ${payload.phone}\n` +
      `📧 <b>Email:</b> ${payload.email}\n` +
      `🎵 <b>TikTok:</b> ${payload.tiktok || 'No proporcionado'}\n` +
      `👥 <b>Facebook:</b> ${payload.facebook || 'No proporcionado'}\n` +
      `🔑 <b>Token:</b> ${payload.token}\n` +
      `📝 <b>Final soñado:</b>\n${payload.ending}\n\n` +
      `⏰ <b>Fecha:</b> ${new Date().toLocaleString('es-EC')}`;

    const url = `https://api.telegram.org/bot${TG_TOKEN}/sendMessage`;
    
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          chat_id: TG_CHAT,
          text: text,
          parse_mode: 'HTML'
        })
      });
      
      if (!response.ok) {
        throw new Error('Error al enviar a Telegram');
      }
      
      console.log('Mensaje enviado a Telegram exitosamente');
      return true;
    } catch (error) {
      console.warn('Error al enviar a Telegram:', error);
      
      // Fallback con método GET si el POST falla
      try {
        const fallbackText = encodeURIComponent(text.replace(/<[^>]*>/g, ''));
        const fallbackUrl = `https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT}&text=${fallbackText}`;
        await fetch(fallbackUrl, {method: 'GET', mode: 'no-cors'});
        console.log('Mensaje enviado con método fallback');
        return true;
      } catch (fallbackError) {
        console.error('Error en ambos métodos:', fallbackError);
        return false;
      }
    }
  }

  // Submit formulario mejorado
  const form = document.getElementById('form');
  const submitBtn = document.getElementById('submitBtn');
  const btnText = submitBtn.querySelector('.btn-text');
  const loading = submitBtn.querySelector('.loading');
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Validar formulario
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    if (!data.name || !data.phone || !data.email || !data.ending) {
      alert('Por favor, completa todos los campos obligatorios');
      return;
    }
    
    // Mostrar estado de carga
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    loading.style.display = 'inline-block';
    
    // Preparar datos
    data.token = token;
    data.createdAt = Date.now();
    data.timestamp = new Date().toISOString();
    
    try {
      // Enviar a Telegram
      const success = await notifyTelegram(data);
      
      // Simular delay para mejor UX
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      if (success) {
        // Mostrar modal de éxito
        successModal.classList.add('show');
        
        // Efecto de pétalos intenso
        intensePetals();
        
        // Resetear formulario después de un delay
        setTimeout(() => {
          form.reset();
          document.getElementById('token').value = token;
        }, 2000);
        
      } else {
        alert('Hubo un problema al enviar tu registro. Por favor, intenta nuevamente.');
      }
      
    } catch (error) {
      console.error('Error:', error);
      alert('Error al procesar tu registro. Verifica tu conexión e intenta nuevamente.');
    } finally {
      // Restaurar botón
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      loading.style.display = 'none';
    }
  });

  // Limpiar pétalos cada cierto tiempo para optimizar rendimiento
  setInterval(() => {
    if (bits.length > 500) {
      bits = bits.slice(-300);
    }
  }, 10000);
</script>
</body>
</html>
